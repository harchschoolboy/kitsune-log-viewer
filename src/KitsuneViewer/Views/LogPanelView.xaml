<UserControl x:Class="KitsuneViewer.Views.LogPanelView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:KitsuneViewer.ViewModels"
             Background="{DynamicResource BackgroundBrush}">
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Toolbar -->
        <Border Grid.Row="0" Background="{DynamicResource SecondaryBackgroundBrush}" 
                BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1"
                Padding="3,2">
            <StackPanel Orientation="Horizontal">
                <!-- Follow toggle -->
                <ToggleButton x:Name="FollowButton" 
                              IsChecked="{Binding IsFollowing}"
                              ToolTip="Auto-scroll to new content"
                              Padding="5,2" Margin="0,0,3,0">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="ðŸ“œ" Margin="0,0,3,0"/>
                        <TextBlock Text="Follow"/>
                    </StackPanel>
                </ToggleButton>
                
                <!-- Pause toggle -->
                <ToggleButton x:Name="PauseButton"
                              IsChecked="{Binding IsPaused}"
                              ToolTip="Pause updates"
                              Padding="5,2" Margin="0,0,3,0">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="â¸" Margin="0,0,3,0"/>
                        <TextBlock Text="Pause"/>
                    </StackPanel>
                </ToggleButton>
                
                <!-- Time Sync toggle -->
                <ToggleButton x:Name="TimeSyncButton"
                              IsChecked="{Binding IsTimeSync}"
                              ToolTip="Synchronize with other logs by timestamp"
                              Padding="5,2" Margin="0,0,3,0">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="ðŸ”—" Margin="0,0,3,0"/>
                        <TextBlock Text="Sync"/>
                    </StackPanel>
                </ToggleButton>
                
                <!-- Word Wrap toggle -->
                <ToggleButton x:Name="WordWrapButton"
                              IsChecked="{Binding IsWordWrap}"
                              ToolTip="Toggle word wrap"
                              Padding="5,2" Margin="0,0,3,0">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="â†©" Margin="0,0,3,0"/>
                        <TextBlock Text="Wrap"/>
                    </StackPanel>
                </ToggleButton>
                
                <Rectangle Width="1" Height="16" Fill="{DynamicResource BorderBrush}" Margin="4,0"/>
                
                <!-- Filter -->
                <TextBlock Text="Filter:" VerticalAlignment="Center" Margin="0,0,3,0"
                           Foreground="{DynamicResource ForegroundBrush}"/>
                <TextBox x:Name="FilterBox" 
                         Text="{Binding FilterText, UpdateSourceTrigger=PropertyChanged, Delay=200}"
                         Width="120" Margin="0,0,3,0" Padding="3,1"
                         ToolTip="Type to filter (auto-applies)"/>
                <Button Content="â‡‰ All" Command="{Binding ApplyFilterToAllCommand}" 
                        ToolTip="Apply this filter to all open tabs"
                        Padding="5,2" Margin="0,0,3,0"/>
                
                <Rectangle Width="1" Height="16" Fill="{DynamicResource BorderBrush}" Margin="4,0"/>
                
                <!-- Clear -->
                <Button Content="ðŸ—‘ Clear" Command="{Binding ClearCommand}" 
                        ToolTip="Clear log content"
                        Padding="5,2" Margin="0,0,3,0"/>
                
                <!-- Copy -->
                <Button Content="ðŸ“‹ Copy" Command="{Binding CopyToClipboardCommand}"
                        ToolTip="Copy all content to clipboard"
                        Padding="5,2"/>
            </StackPanel>
        </Border>
        
        <!-- Log Content - Using ListBox for virtualization -->
        <ListBox x:Name="LogListBox" Grid.Row="1"
                 ItemsSource="{Binding FilteredEntries}"
                 SelectionMode="Extended"
                 VirtualizingPanel.IsVirtualizing="True"
                 VirtualizingPanel.VirtualizationMode="Recycling"
                 ScrollViewer.HorizontalScrollBarVisibility="{Binding IsWordWrap, Converter={StaticResource BoolToScrollBarVisibilityConverter}}"
                 Background="{DynamicResource BackgroundBrush}"
                 Foreground="{DynamicResource ForegroundBrush}"
                 BorderThickness="0"
                 FontFamily="Cascadia Code, Consolas, Courier New"
                 FontSize="13"
                 SelectionChanged="LogListBox_SelectionChanged"
                 KeyDown="LogListBox_KeyDown">
            <ListBox.ContextMenu>
                <ContextMenu>
                    <MenuItem Header="Copy Selected" Command="{Binding CopySelectedCommand}" InputGestureText="Ctrl+C">
                        <MenuItem.Icon>
                            <TextBlock Text="ðŸ“‹"/>
                        </MenuItem.Icon>
                    </MenuItem>
                    <MenuItem Header="Copy All" Command="{Binding CopyToClipboardCommand}">
                        <MenuItem.Icon>
                            <TextBlock Text="ðŸ“„"/>
                        </MenuItem.Icon>
                    </MenuItem>
                    <Separator/>
                    <MenuItem Header="Select All" Click="SelectAll_Click" InputGestureText="Ctrl+A">
                        <MenuItem.Icon>
                            <TextBlock Text="â˜‘"/>
                        </MenuItem.Icon>
                    </MenuItem>
                </ContextMenu>
            </ListBox.ContextMenu>
            <ListBox.ItemContainerStyle>
                <Style TargetType="ListBoxItem">
                    <Setter Property="Padding" Value="5,2"/>
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}"/>
                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ListBoxItem">
                                <Border x:Name="Bd" Background="{TemplateBinding Background}" 
                                        Padding="{TemplateBinding Padding}">
                                    <ContentPresenter/>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter TargetName="Bd" Property="Background" 
                                                Value="{DynamicResource SelectionBrush}"/>
                                    </Trigger>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter TargetName="Bd" Property="Background" 
                                                Value="{DynamicResource TertiaryBackgroundBrush}"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </ListBox.ItemContainerStyle>
            <ListBox.ItemTemplate>
                <DataTemplate>
                    <TextBlock x:Name="LogText" Text="{Binding DisplayText}" 
                               Foreground="{DynamicResource ForegroundBrush}"
                               TextWrapping="{Binding DataContext.IsWordWrap, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BoolToTextWrappingConverter}}"/>
                    <DataTemplate.Triggers>
                        <DataTrigger Binding="{Binding Level}" Value="Error">
                            <Setter TargetName="LogText" Property="Foreground" Value="{DynamicResource ErrorBrush}"/>
                        </DataTrigger>
                        <DataTrigger Binding="{Binding Level}" Value="Warning">
                            <Setter TargetName="LogText" Property="Foreground" Value="{DynamicResource WarningBrush}"/>
                        </DataTrigger>
                        <DataTrigger Binding="{Binding Level}" Value="Debug">
                            <Setter TargetName="LogText" Property="Foreground" Value="{DynamicResource DebugBrush}"/>
                        </DataTrigger>
                        <DataTrigger Binding="{Binding Level}" Value="Trace">
                            <Setter TargetName="LogText" Property="Foreground" Value="{DynamicResource TraceBrush}"/>
                        </DataTrigger>
                        <DataTrigger Binding="{Binding Level}" Value="Info">
                            <Setter TargetName="LogText" Property="Foreground" Value="{DynamicResource InfoBrush}"/>
                        </DataTrigger>
                    </DataTemplate.Triggers>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>
        
        <!-- Status Bar -->
        <Border Grid.Row="2" Background="{DynamicResource SecondaryBackgroundBrush}"
                BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,1,0,0"
                Padding="8,4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <TextBlock Text="{Binding StatusText}" 
                           Foreground="{DynamicResource ForegroundBrush}"/>
                
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <TextBlock Text="Lines: " Foreground="{DynamicResource ForegroundDimBrush}"/>
                    <TextBlock Text="{Binding TotalLines}" 
                               Foreground="{DynamicResource AccentBrush}"
                               FontWeight="Bold"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>
